function initMap(){clearTimeout(googleRequestTimeout),vm.mapLoad(!0),map=new google.maps.Map(document.getElementById("map"),{center:initial,zoom:15,mapTypeControl:!1}),bounds=new google.maps.LatLngBounds,google.maps.event.addDomListener(window,"resize",function(){map.fitBounds(bounds)}),placesSearch=new google.maps.places.Autocomplete(document.getElementById("places-search")),placesSearch.addListener("place_changed",function(){searchPlaces()}),largeInfowindow=new google.maps.InfoWindow,icon={url:"http://chart.googleapis.com/chart?chst=d_map_spin&chld=1.15|0|679df6|40|_|%E2%80%A2",size:new google.maps.Size(21,34),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(10,34),scaledSize:new google.maps.Size(21,34)},searchPlaces({location:initial})}function searchPlaces(a,b){function c(){cm.marker()&&cm.marker().setMap(null),map.setCenter(place.geometry.location);var a=place.address_components[0].short_name,c=place.formatted_address;"undefined"==typeof a&&(a=c),vm.title(a),vm.center(c),cm.create(place),newPlaceSearch(place.formatted_address,b)}if(vm.locationError(0),vm.searchEmpty(!1),vm.searchFailed(!1),"undefined"==typeof a)return place=placesSearch.getPlace()||place,void(""===place.name?vm.searchEmpty(!0):place.geometry?c():vm.searchFailed(!0));var d=new google.maps.Geocoder;d.geocode(a,function(a,b){b==google.maps.GeocoderStatus.OK?(place=a[0],c()):vm.searchFailed(!0)})}function nonce_generate(){return Math.floor(1e12*Math.random()).toString()}function newPlaceSearch(a,b){pm.hide(),pm.markers.removeAll();var c={oauth_consumer_key:YELP_KEY,oauth_token:YELP_TOKEN,oauth_nonce:nonce_generate(),oauth_timestamp:Math.floor(Date.now()/1e3),oauth_signature_method:"HMAC-SHA1",oauth_version:"1.0",callback:"cb",location:a,sort:1,radius_filter:1e4};b&&(c.term=b);var d=oauthSignature.generate("GET",YELP_URL,c,YELP_KEY_SECRET,YELP_TOKEN_SECRET);c.oauth_signature=d;var e={url:YELP_URL,data:c,cache:!0,dataType:"jsonp",success:function(a){vm.yelpError(!1),nearbySearch(a)},fail:function(a,b,c){vm.yelpError(!0)}};$.ajax(e)}function nearbySearch(a){var b=a.businesses;b.forEach(function(a){"undefined"!=typeof a.location.coordinate&&pm.create(a)}),vm.showListings()}function googleError(){vm.mapError(!0)}var map,placesSearch,place,directionsDisplay,largeInfowindow,modes=["Driving","Walking","Bicycling","Transit"],bounds,initial={lat:37.387474,lng:-122.057543},latlng={lat:0,lng:0},icon,googleRequestTimeout=setTimeout(function(){vm.mapError(!0)},8e3),YELP_URL="http://api.yelp.com/v2/search",YELP_KEY="GBzdouuzuehAS1eKl5WGHg",YELP_KEY_SECRET="jAl4d0vuCI7XJY3DMFVsYxET4PQ",YELP_TOKEN="KhvBiuMmDYHKB9L9B5wzoNr9XywM7Dxh",YELP_TOKEN_SECRET="wDzMn0gVn8xKBu4l26soAIg1f9E";ko.bindingHandlers.slideVisible={init:function(a,b){var c=ko.utils.unwrapObservable(b());$(a).toggle(c)},update:function(a,b){var c=b(),d=ko.utils.unwrapObservable(c);d?$(a).slideDown("slow"):$(a).slideUp("fast")}};var PlaceMarkers=function(){var a=this;a.markers=ko.observableArray([]),a.selected=ko.observable(),a.bounce=function(a){a.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){a.setAnimation(null)},1500)},this.toggleDetails=function(b){a.bounce(b),map.panTo(b.getPosition()),a.populateInfoWindow(b,largeInfowindow)},a.create=function(b){var c=b.location.coordinate;latlng.lat=c.latitude,latlng.lng=c.longitude;var d=new google.maps.Marker({position:latlng,title:b.name,id:b.id,animation:google.maps.Animation.DROP});d.place=b,d.navigateEnabled=ko.observable(!1),a.markers.push(d),d.addListener("click",function(){a.toggleDetails(this),a.markers().forEach(function(a){a.id===d.id?a.navigateEnabled(!0):a.navigateEnabled(!1)})}),d.addListener("mouseover",function(){a.bounce(this)}),d.addListener("mouseout",function(){this.setAnimation(null)})},a.hide=function(){a.markers().forEach(function(a){a.setMap(null)})},a.populateInfoWindow=function(a,b){if(b.marker!=a){b.setContent(""),b.marker=a,b.addListener("closeclick",function(){b.marker=null});var c,d,e=a.place,f=e.image_url?'<img src="'+e.image_url+'" alt="Business photo">':"No image provided",g=e.name?e.name:"No name provided",h=e.url?'<a class="info-link" href="'+e.url+'" target="_blank">'+g+"</a>":g,i=e.location.address?e.location.address:"Address not found",j=e.rating?e.rating:"No rating available",k=e.rating_img_url?'<img class="info-rating-left" src="'+e.rating_img_url+'" alt="'+j+'">':j,l=e.review_count?"Based on "+e.review_count+" reviews":"No review count provided";if(e.categories){var m=[];e.categories.forEach(function(a){m.push(a[0])}),d=m.slice(0,2).join(",")}c='<div class="info"><section class="info-left">'+f+'</section><section class="info-right"><div class="info-name">'+h+'</div><div class="info-addr">'+i+'</div><div class="info-rating">'+k+'<a href="https://www.yelp.com" target="_blank"><img class="info-yelp" src="img/yelp.png" alt="Yelp logo"></a></div><div class="info-review">'+l+'</div><div class="info-cate">'+d+"</div></section></div>",b.setContent(c),b.open(map,a)}}},CenterMarker=function(){var a=this;a.marker=ko.observable(),a.bounce=function(){a.marker().setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){a.marker().setAnimation(null)},1500)},a.create=function(b){var c=new google.maps.Marker({map:map,position:b.geometry.location,title:b.name,icon:icon,id:b.id,animation:google.maps.Animation.DROP});a.marker(c),c.addListener("click",function(){a.bounce(this),map.panTo(this.getPosition())}),c.addListener("mouseover",function(){a.bounce(this)}),c.addListener("mouseout",function(){this.setAnimation(null)})}},ViewModel=function(){var a=this;a.btn=ko.observable(!1),a.mapLoad=ko.observable(!1),a.toggleBtn=function(){a.mapLoad()&&a.btn(!a.btn())},a.title=ko.observable("your favourite!"),a.center=ko.observable(""),a.querystr=ko.observable(""),a.showDirections=ko.observable(!1),a.mapError=ko.observable(!1),a.yelpError=ko.observable(!1),a.directionsError=ko.observable(!1),a.searchEmpty=ko.observable(!1),a.searchFailed=ko.observable(!1),a.locationError=ko.observable(0),a.terms=ko.observableArray(["food","restaurants","active life","medical"]),a.mode=ko.observableArray([]),modes.forEach(function(b,c){var d={};d.text=b,d.selected=ko.observable(!1),a.mode.push(d)}),a.mode()[0].selected(!0),a.list=ko.computed(function(){return 0===$.trim(a.querystr()).length?pm.markers():ko.utils.arrayFilter(pm.markers(),function(b){return b.title.toLowerCase().indexOf(a.querystr().toLowerCase())>-1})}),a.showListings=function(){bounds=new google.maps.LatLngBounds;var b=a.list(),c=b.length;if(0!==c){for(var d=0;d<c;d++)b[d].setMap(map),bounds.extend(b[d].position);map.fitBounds(bounds)}},a.filter=function(){pm.hide(),a.showListings()},a.myPosition=function(){navigator.geolocation?navigator.geolocation.getCurrentPosition(function(b){initial.lat=b.coords.latitude,initial.lng=b.coords.longitude,searchPlaces({location:initial}),a.locationError(0)},function(){a.locationError(1)}):a.locationError(2)},a.termSerach=function(a){searchPlaces(void 0,a)},a.listMouseOver=function(a){pm.bounce(a)},a.listMouseOut=function(a){a.setAnimation(null)},a.listClick=function(b){pm.toggleDetails(b),a.list().forEach(function(a){a.navigateEnabled(!1)}),b.navigateEnabled(!0)},a.navigate=function(b){pm.selected(b),a.showDirections(!0),a.displayDirections(a.mode()[0])},a.displayDirections=function(b){pm.hide(),cm.marker().setMap(null),a.mode().forEach(function(a){a.selected(!1)}),b.selected(!0);var c=new google.maps.DirectionsService;"undefined"!=typeof directionsDisplay&&(directionsDisplay.setMap(null),directionsDisplay.setPanel(null));var d={origin:cm.marker().position,destination:pm.selected().position,travelMode:google.maps.TravelMode[b.text.toUpperCase()]};c.route(d,function(a,b){b===google.maps.DirectionsStatus.OK?(vm.directionsError(!1),directionsDisplay=new google.maps.DirectionsRenderer({map:map,directions:a,draggable:!0,polylineOptions:{strokeColor:"green"},panel:document.getElementById("panel")})):vm.directionsError(!0)})},a.hideDirections=function(){a.showDirections(!1),cm.marker().setMap(map),"undefined"!=typeof directionsDisplay&&(directionsDisplay.setMap(null),directionsDisplay.setPanel(null)),a.showListings()}},cm=new CenterMarker,pm=new PlaceMarkers,vm=new ViewModel;ko.applyBindings(vm);